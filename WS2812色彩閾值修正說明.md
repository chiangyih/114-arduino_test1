# WS2812 色彩閾值修正說明

## 修正日期
2025-01-XX

## 修正內容

### 1. 色彩閾值範圍調整
根據 `Arduino_WS2812_Integration_Guide.md` 規範，將 LOAD 命令的 CPU 負載色彩閾值從原本的四段式改為三段式：

#### 修正前（舊規格）：
| CPU Loading | 顏色 | RGB 值 | 說明 |
|-------------|------|--------|------|
| 0% - 24% | 🟢 綠色 | (0, 255, 0) | 正常 |
| 25% - 49% | 🟡 黃色 | (255, 255, 0) | 警告 |
| 50% - 74% | 🟠 橙色 | (255, 128, 0) | 注意 |
| 75% - 100% | 🔴 紅色 | (255, 0, 0) | 高負載 |

#### 修正後（新規格，符合整合指南）：
| CPU Loading | 顏色 | RGB 值 | 說明 |
|-------------|------|--------|------|
| 0% - 50% | 🟢 綠色 | (0, 255, 0) | 正常負載 |
| 51% - 84% | 🟡 黃色 | (255, 255, 0) | 中度負載 |
| 85% - 100% | 🔴 紅色 | (255, 0, 0) | 高負載 |

### 2. 修正原因
- 遵循 `Arduino_WS2812_Integration_Guide.md` 標準規範
- 確保與 PC 端監控程式的預期行為一致
- 簡化為三段式判斷，更符合工業應用標準（綠色=安全、黃色=警告、紅色=危險）

### 3. 不影響的功能
✅ 其他選單功能（RGB Offline 模式）維持不變  
✅ EEPROM 讀寫功能正常  
✅ 藍牙連線與心跳檢測正常  
✅ TFT 顯示與按鍵操作正常  
✅ 倒數計時功能正常  

---

## 測試步驟

### 測試環境
- Arduino UNO (ATmega328P)
- WS2812 x 8 (連接於 D5)
- HC-05 藍牙模組 (9600 bps)
- 序列埠監視器或藍牙終端

### 測試案例

#### 測試 1：綠色顯示（正常負載）
```
發送命令：LOAD 30
預期結果：所有 8 顆 WS2812 顯示綠色 (0, 255, 0)
驗證點：CPU loading 30% 屬於 0-50% 範圍
```

#### 測試 2：邊界值 - 50%
```
發送命令：LOAD 50
預期結果：所有 8 顆 WS2812 顯示綠色 (0, 255, 0)
驗證點：50% 仍屬於綠色範圍（0-50%）
```

#### 測試 3：黃色顯示（中度負載）
```
發送命令：LOAD 65
預期結果：所有 8 顆 WS2812 顯示黃色 (255, 255, 0)
驗證點：CPU loading 65% 屬於 51-84% 範圍
```

#### 測試 4：邊界值 - 84%
```
發送命令：LOAD 84
預期結果：所有 8 顆 WS2812 顯示黃色 (255, 255, 0)
驗證點：84% 仍屬於黃色範圍（51-84%）
```

#### 測試 5：紅色顯示（高負載）
```
發送命令：LOAD 90
預期結果：所有 8 顆 WS2812 顯示紅色 (255, 0, 0)
驗證點：CPU loading 90% 屬於 85-100% 範圍
```

#### 測試 6：邊界值 - 85%
```
發送命令：LOAD 85
預期結果：所有 8 顆 WS2812 顯示紅色 (255, 0, 0)
驗證點：85% 開始進入紅色範圍（85-100%）
```

#### 測試 7：最大值
```
發送命令：LOAD 100
預期結果：所有 8 顆 WS2812 顯示紅色 (255, 0, 0)
驗證點：100% 屬於紅色範圍
```

#### 測試 8：最小值
```
發送命令：LOAD 0
預期結果：所有 8 顆 WS2812 顯示綠色 (0, 255, 0)
驗證點：0% 屬於綠色範圍
```

### 完整測試腳本（Python）

```python
import serial
import time

# 設定序列埠（請根據實際情況修改 COM port）
ser = serial.Serial('COM5', 9600, timeout=1)
time.sleep(2)  # 等待 Arduino 重置

# 測試案例
test_cases = [
    (0, "綠色", "最小值"),
    (30, "綠色", "正常負載"),
    (50, "綠色", "邊界值-綠色上限"),
    (51, "黃色", "邊界值-黃色下限"),
    (65, "黃色", "中度負載"),
    (84, "黃色", "邊界值-黃色上限"),
    (85, "紅色", "邊界值-紅色下限"),
    (90, "紅色", "高負載"),
    (100, "紅色", "最大值")
]

print("=== WS2812 色彩閾值測試 ===\n")

for cpu_load, expected_color, description in test_cases:
    command = f"LOAD {cpu_load}\n"
    ser.write(command.encode())
    time.sleep(0.2)
    
    response = ser.readline().decode().strip()
    
    print(f"[測試] CPU: {cpu_load:3d}% → 預期: {expected_color} ({description})")
    print(f"       回應: {response}")
    
    if response == "ACK":
        print("       ✅ 命令成功執行")
    else:
        print("       ❌ 命令執行失敗")
    
    time.sleep(2)  # 等待 2 秒讓測試者觀察 LED 顏色
    print()

ser.close()
print("測試完成！")
```

### 手動測試（序列埠監視器）

1. 開啟 Arduino IDE 序列埠監視器
2. 設定 Baud Rate 為 **9600**
3. 設定行結束符號為 **Newline** 或 **Both NL & CR**
4. 依序輸入以下命令，並觀察 WS2812 顏色變化：

```
LOAD 0      → 應顯示綠色
LOAD 30     → 應顯示綠色
LOAD 50     → 應顯示綠色
LOAD 51     → 應顯示黃色
LOAD 65     → 應顯示黃色
LOAD 84     → 應顯示黃色
LOAD 85     → 應顯示紅色
LOAD 90     → 應顯示紅色
LOAD 100    → 應顯示紅色
```

每次發送後應該會收到 `ACK` 回應。

---

## 程式碼變更位置

### 檔案：`src/main.cpp`
**函式**：`handleBluetoothData()`  
**行號**：約 847-868 行  

```cpp
// LOAD 命令：更新 WS2812 顏色（格式：LOAD <VAL>）
else if (receivedData.startsWith("LOAD ")) {
  int cpuLoad = receivedData.substring(5).toInt();
  
  // 根據 CPU Loading 百分比顯示不同顏色（依 Arduino_WS2812_Integration_Guide.md 規範）
  uint32_t color;
  if (cpuLoad <= 50) {
    color = strip.Color(0, 255, 0);      // 綠色：0-50% (正常負載)
  } else if (cpuLoad <= 84) {
    color = strip.Color(255, 255, 0);    // 黃色：51-84% (中度負載)
  } else {
    color = strip.Color(255, 0, 0);      // 紅色：85-100% (高負載)
  }
  
  // 設定所有 WS2812 LED
  for (int i = 0; i < WS2812_COUNT; i++) {
    strip.setPixelColor(i, color);
  }
  strip.show();
  
  Serial.println("ACK");
}
```

---

## 參考文件
- `FirmwareSpec.md`：韌體功能規格（定義 LOAD 命令格式）
- `Arduino_WS2812_Integration_Guide.md`：WS2812 整合指南（定義色彩閾值範圍）
- `藍牙連線測試說明.md`：藍牙測試與除錯說明

---

## 檢查清單

測試完成後，請確認以下項目：

- [ ] LOAD 0-50 顯示綠色
- [ ] LOAD 51-84 顯示黃色
- [ ] LOAD 85-100 顯示紅色
- [ ] 每次命令都收到 ACK 回應
- [ ] RGB Offline 模式仍正常運作（紅3/綠6/藍8/彩虹）
- [ ] EEPROM 讀寫功能正常
- [ ] 藍牙連線顯示正確
- [ ] TFT 選單操作正常
- [ ] 倒數計時功能正常

---

## 備註

### 為什麼選擇這個閾值範圍？
這個閾值範圍來自於 CPU 監控的行業標準：
- **0-50% = 綠色**：CPU 有足夠的閒置資源，系統運作正常
- **51-84% = 黃色**：CPU 開始繁忙，但仍在可接受範圍內，需要注意
- **85-100% = 紅色**：CPU 接近滿載，系統可能出現效能問題，需要立即處理

這樣的設計更符合工業監控系統的「綠-黃-紅」三色警示標準。

### 與整合指南的一致性
修正後的程式碼完全符合 `Arduino_WS2812_Integration_Guide.md` 的色彩映射規範（第 37-39 行），確保與測試標準一致。
