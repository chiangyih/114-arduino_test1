# v2.0 藍牙資料驗證改進摘要

## 🚀 主要改進

本版本針對藍牙資料接收的驗證邏輯進行重大優化，實現了更寬鬆、更穩定的命令識別機制。

---

## 📋 改進項目

### 1. **寬鬆命令匹配（LOAD、WRITE）**
v1.0 採用嚴格的前綴匹配方式，容易因格式差異而失敗。
v2.0 改為寬鬆匹配，只要字串包含命令關鍵字即可識別。

| 特性 | v1.0 | v2.0 |
|------|------|------|
| **前綴匹配** | `strncmp(..., "LOAD ", 5)` | `strstr(..., "LOAD")` |
| **多空格** | ❌ 拒絕 | ✅ 接受 |
| **無空格** | ❌ 拒絕 | ✅ 接受 |
| **亂碼容錯** | ❌ 拒絕 | ✅ 接受 |

### 2. **資料清理流程**
v1.0 只移除末尾空格，無法處理前導空格。
v2.0 實現完整的前導/末尾空格清理及字串位移。

```cpp
// v1.0：不完整
while (receivedDataLen > 0 && receivedData[receivedDataLen - 1] == ' ') {
    receivedData[--receivedDataLen] = '\0';
}

// v2.0：完整
size_t start = 0;
while (start < receivedDataLen && receivedData[start] == ' ') {
    start++;
}
// ... 末尾空格移除 ...
if (start > 0) {
    memmove(receivedData, receivedData + start, receivedDataLen - start);
}
```

### 3. **智慧數字搜尋**
v1.0 使用固定位移提取數字，易受格式變化影響。
v2.0 動態搜尋字串中的第一個數字。

```cpp
// v1.0：位移提取
int value = atoi(&receivedData[6]);  // 假設 WRITE 後恰好 6 位置

// v2.0：動態搜尋
char* valuePtr = receivedData;
while (*valuePtr != '\0' && !isdigit(*valuePtr)) {
    valuePtr++;
}
if (*valuePtr != '\0') {
    int value = atoi(valuePtr);
}
```

### 4. **精確匹配命令（CONNECT、DISCONNECT、PING）**
確保關鍵命令的精確執行，防止誤認。

| 命令 | 匹配方式 | 說明 |
|------|---------|------|
| CONNECT | `strcmp()` | 完全匹配 |
| DISCONNECT | `strcmp()` | 完全匹配 |
| PING | `strcmp()` | 完全匹配 |

---

## 🔧 技術改進

### 容錯能力提升

#### 前導/末尾空格
```
輸入：  LOAD 50   
清理：LOAD 50
✅ 成功識別
```

#### 多個空格
```
輸入：LOAD   50
提取：搜尋數字 → 50
✅ 成功識別
```

#### 無空格格式
```
輸入：LOAD50
提取：搜尋數字 → 50
✅ 成功識別
```

#### 亂碼混雜（關鍵改進）
```
輸入：LOAD❌RLOAD 25❌LOAD
驗證流程：
  1. strstr() 找到 "LOAD" ✓
  2. 搜尋第一個數字 → 25 ✓
  3. 驗證範圍 → 0-100 ✓
✅ 成功識別 LOAD 25
```

### 範圍驗證
- **LOAD 命令**：0-100（CPU 百分比）
- **WRITE 命令**：0-255（EEPROM 值）
- 超出範圍自動回應 `ERR`

---

## 📊 效能對比

| 指標 | v1.0 | v2.0 | 改進 |
|------|------|------|------|
| 格式相容性 | 1 種 | 5+ 種 | +400% |
| 亂碼容錯能力 | 無 | 是 | 新增 |
| 代碼複雜度 | 簡 | 中 | +適中 |
| 記憶體使用 | 少 | 少 | 不變 |

---

## 🧪 測試案例

### 標準格式
```
LOAD 50
WRITE 123
✅ 均正常識別
```

### 容錯格式
```
LOAD  50       （多空格）
LOAD50         （無空格）
WRITE  123     （多空格）
WRITE123       （無空格）
✅ 均正常識別
```

### 亂碼測試（真實藍牙干擾）
```
LOAD❌RLOAD 25❌LOAD 31      → 識別為 LOAD 25
L❌#❌LOAD❌RLOAD 20         → 識別為 LOAD 20
LOAD❌❌❌50                  → 識別為 LOAD 50
✅ 均成功恢復正確資料
```

### 邊界值測試
```
LOAD 0         ✅ ACK (綠色)
LOAD 50        ✅ ACK (綠色)
LOAD 51        ✅ ACK (黃色)
LOAD 84        ✅ ACK (黃色)
LOAD 85        ✅ ACK (紅色)
LOAD 100       ✅ ACK (紅色)
LOAD 101       ❌ ERR
WRITE 0        ✅ ACK
WRITE 255      ✅ ACK
WRITE 256      ❌ ERR
```

---

## 📝 程式碼位置

### 主要改進函式
- **檔案**：`src/main.cpp`
- **行號**：900-1050 (藍牙資料處理函式)

### 關鍵改進
1. **行 905-925**：前導/末尾空格清理
2. **行 933-945**：WRITE 命令（寬鬆匹配 + 動態數字搜尋）
3. **行 947-978**：LOAD 命令（寬鬆匹配 + 動態數字搜尋）
4. **行 980-1001**：精確匹配命令

---

## ✅ 驗收標準

所有以下情況都應正確處理：

- [x] 標準格式：`LOAD 50`
- [x] 多空格格式：`LOAD  50`
- [x] 無空格格式：`LOAD50`
- [x] 前導空格：` LOAD 50`
- [x] 末尾空格：`LOAD 50 `
- [x] 亂碼混雜：`LOAD❌RLOAD 25❌`
- [x] 超出範圍：`LOAD 150` → ERR
- [x] 邊界值：`LOAD 0`、`LOAD 100` → ACK
- [x] 精確匹配：`PING`、`CONNECT`、`DISCONNECT`

---

## 🔄 升級指南

### 現有系統升級
如果使用 v1.0，建議升級至 v2.0 以獲得更好的藍牙傳輸穩定性。

### 升級步驟
1. 下載最新韌體
2. 使用 PlatformIO 重新編譯：`pio run`
3. 上傳至 Arduino：`pio run --target upload`
4. 執行完整系統測試

### 向後相容性
✅ v2.0 完全相容 v1.0 的所有命令格式，升級無風險。

---

## 📞 技術支援

### 常見問題
**Q: 升級後出現亂碼？**  
A: 這是正常現象，v2.0 會自動從亂碼中提取有效資料。若仍出現問題，檢查：
- HC-05 波特率（應為 9600）
- 藍牙連接線是否牢固
- 序列埠監視器的資訊欄

**Q: 為什麼 LOAD 可以不加空格？**  
A: v2.0 改進了容錯能力，即使格式不規範也能識別。這是特意設計，以應對真實藍牙傳輸中的各種問題。

---

**版本**：v2.0  
**發佈日期**：2025-11-20  
**對應檔案版本**：main.cpp v10+  
**測試平台**：Arduino UNO + HC-05 (9600bps)
