# 裝置端韌體需求規格表（FirmwareSpec.md）
## 113 學年度 全國高級中等學校 工業類科學生技藝競賽
### 電腦修護職類 第二站 — 個人電腦 USB / 藍牙介面卡製作及控制
### MCU：ATmega328P（Arduino UNO 架構）
### 通訊模組：HC-05（Bluetooth SPP）
### 顯示模組：ST7735（1.8 吋 SPI TFT LCD，128×160，8 pins）
### 使用的library
#### Adafruit GFX Library@^1.12.3
#### Adafruit SSD1306@^2.5.15
#### Adafruit NeoPixel@^1.15.2
#### Adafruit ST7735 and ST7789 Library@^1.11.0
#### Engnin_comp_2025.h
---

## 目錄（TOC）
1. [系統總覽](#系統總覽)  
2. [硬體架構需求](#硬體架構需求)  
3. [功能性需求總表](#功能性需求總表)  
4. [主迴圈與初始化流程](#主迴圈與初始化流程)  
5. [OLED / TFT 顯示需求](#oled--tft-顯示需求)  
6. [選單系統規格](#選單系統規格)  
7. [RGB Offline 模式控制](#rgb-offline-模式控制)  
8. [CountDown 模式控制](#countdown-模式控制)  
9. [藍牙通訊命名與連線規格](#藍牙通訊命名與連線規格)  
10. [EEPROM 操作與資料驗證](#eeprom-操作與資料驗證)  
11. [狀態指示與錯誤處理](#狀態指示與錯誤處理)  
12. [測試與評分依據對應](#測試與評分依據對應)

---

## 系統總覽
本韌體負責控制 **ATmega328P MCU** 與 **PC 端 Visual Basic 控制軟體** 之間的通訊互動，  
主要透過 **HC-05 藍牙模組（SPP 模式）** 進行資料交換，並以 **ST7735 TFT LCD 顯示模組** 呈現狀態資訊。  

韌體核心任務：
- LED / WS2812 燈號控制  
- TFT 顯示訊息與選單  
- 藍牙資料收發  
- 倒數計時與 EEPROM 資料儲存  

---

## 硬體架構需求

| 模組 | 接腳 | 功能說明 |
|------|------|----------|
| ATmega328P | MCU 主控核心 | 使用 Arduino UNO 相容板 |
| Red LED | D13 | CPU 運行指示燈 |
| WS2812 x 8 | D5 | RGB 顏色顯示控制 |
| ST7735 TFT LCD | SPI (D18, D19, D10, D8, D9, VCC, GND, D6) | 主選單與訊息顯示 | 
| HC-05 Bluetooth 模組 | TX/RX (D0, D1) | 藍牙 SPP 通訊 |
| 按鍵模組 | Up A0 / Down A1 / Enter A2 / Return A3 | 選單導覽與模式控制 |
| EEPROM（內建） | MCU 內部 | 儲存輸入資料 |

---

## 功能性需求總表

| 編號 | 功能名稱 | 功能說明 | 對應試題編號 |
|------|-----------|-----------|---------------|
| F1 | CPU 運行指示燈閃爍 | Red LED 以固定頻率閃爍，顯示系統正常運行 | B-1 |
| F2 | TFT 顯示初始化畫面 | 開機後顯示「TCIVS / C201」，延遲約 2 秒後進入選單 | B-2 |
| F3 | RGB Offline 選單 | 可切換燈色：Red、Green、Blue、Gradient RGB | B-3 |
| F4 | CountDown 選單 | 由 00:00:10 倒數至 00:00:00，完成時閃爍三次且顯示粉紅色 | B-4 |
| F5 | 藍牙模組命名邏輯 | 依崗位號碼轉 BIN 判斷奇偶，命名 ODD-01-BBBB | B-5 |
| F6 | 藍牙通訊控制 | 接收 / 回覆 PC 命令；支援 Connected/Disconnect 狀態 | B-6 |
| F7 | Connect to BLE 模式 | 接收 CPU Loading 資料，依值顯示對應顏色 | B-7 |
| F8 | EEPROM 寫入 / 讀取 | 接收 PC 傳來十進位數值寫入 EEPROM，並可於選單中讀出 | B-8 |

---

## 主迴圈與初始化流程
```
setup():
    初始化 GPIO / SPI / UART / TFT
    設定 HC-05 名稱（依崗位號碼判斷 ODD/EVEN）
    顯示開機畫面「TCIVS / C201」
    延遲 2 秒 → 進入選單主畫面

loop():
    檢查按鍵輸入
    處理選單邏輯
    監控藍牙資料收發
    更新 TFT 顯示內容
    控制 WS2812 顏色顯示
```

---

## OLED / TFT 顯示需求

| 顯示階段 | 顯示內容 |
|-----------|-----------|
| 開機階段 | TCIVS（第一行） / C201（第二行） |
| 選單階段 | MENU 畫面含三項：Connect to BLE、RGB Offline、CountDown、EEPROM |
| EEPROM 顯示 | 顯示 EEPROM 內部十進制數值 |

---

## 選單系統規格
- 使用四鍵控制（Up、Down、Enter、Return）
- 支援多層選單結構
- 每項選單均以 TFT 更新顯示內容  
- 回上層選單需具備防抖與延遲判斷

---

## RGB Offline 模式控制
| 顏色模式 | 顯示說明 | WS2812 動作 |
|-----------|-----------|--------------|
| Red | 顯示 3 顆紅色 LED | 閃爍模式 |
| Green | 顯示 6 顆綠色 LED | 閃爍模式 |
| Blue | 顯示 8 顆藍色 LED | 閃爍模式 |
| Gradient RGB | 顯示 8 顆漸層色 LED | 緩慢變色循環 |

---

## CountDown 模式控制
| 功能 | 說明 |
|------|------|
| 起始時間 | 00:00:10 |
| 結束條件 | 00:00:00 時閃爍三次、粉紅色顯示 |
| 操作邏輯 | Enter 暫停 / Enter 繼續 / Return 回選單 |

---

## 藍牙通訊命名與連線規格
### 模組名稱格式
```
ODD-01-BBBB
```
- `01`：崗位號碼  
- `BBBB`：崗位號碼的二進位低位元  
- 奇偶判斷以最右位為依據（01 → 奇數 → ODD）。

### 通訊內容
- HC-05 使用 SPP 模式（9600bps）
- 支援命令：
  - `WRITE <DEC>` → 寫入 EEPROM（寬鬆匹配）
  - `LOAD <VAL>` → 更新 WS2812 顏色顯示（寬鬆匹配）
  - `PING` / `ACK` → 心跳確認（精確匹配）
  - `CONNECT` → 建立連線（精確匹配）
  - `DISCONNECT` → 中斷連線（精確匹配）

### 命令驗證規則（v2.0 改進）

#### 寬鬆匹配命令（LOAD、WRITE）
- 只需字串包含命令關鍵字
- 自動在字串中搜尋第一個數字
- 容忍多個空格、前導/末尾空格
- 容忍亂碼混雜（例：`LOAD❌RLOAD 25❌LOAD`）
- 範圍驗證：LOAD (0-100)、WRITE (0-255)

#### 精確匹配命令（CONNECT、DISCONNECT、PING）
- 完全匹配命令內容
- 前導/末尾空格會被清除  

---

## EEPROM 操作與資料驗證
- 接受 PC 端透過藍牙發送的 `WRITE <0-255>` 命令
- 寫入成功可於選單「EEPROM」讀出顯示十進位數
- 實現簽名機制：寫入簽名 (0xAA) 至地址 1，防止讀取未初始化的亂數
- 數值若錯誤或超出範圍 (0-255)，回應 `ERR` 並不更新 EEPROM

### EEPROM 儲存結構
| 地址 | 內容 | 用途 |
|------|------|------|
| 0 | 數值 | 儲存使用者寫入的十進位數值 (0-255) |
| 1 | 簽名 (0xAA) | 初始化標記，驗證 EEPROM 是否被寫入過 |

### 寫入驗證規則（v2.0 改進）
- **寬鬆匹配**：只需字串包含 "WRITE" 關鍵字
- **智慧搜尋**：自動在整個字串中搜尋第一個數字
- **格式容錯**：支援多空格、無空格、前導/末尾空格
- **亂碼容錯**：藍牙干擾時可自動恢復正確資料
- **範圍驗證**：數值必須在 0-255 範圍內

---

## 狀態指示與錯誤處理
| 狀態 | 顯示 / LED 反應 |
|------|----------------|
|------|----------------|
| CPU 正常 | Red LED 閃爍 |
| BLE Connected | TFT 顯示 Connected；藍燈恆亮 |
| BLE Disconnect | TFT 顯示 Disconnect；藍燈閃爍 |
| EEPROM 錯誤 | TFT 顯示 Error: EEPROM |

---

## 測試與評分依據對應
| 評分項目 | 功能對應 | 韌體測試點 |
|------------|------------|--------------|
| CPU LED 閃爍 | F1 | 檢查閃爍頻率與穩定度 |
| 開機顯示 | F2 | 檢查 2 秒延遲後進入選單 |
| RGB 控制 | F3 | 顏色同步顯示 |
| 倒數計時 | F4 | 倒數、暫停與恢復正常運作 |
| 藍牙命名 | F5 | 名稱符合奇偶規則 (ODD-01-BBBB) |
| BLE 通訊 | F6 | Connected / Disconnect 自動偵測 |
| BLE 顏色控制 | F7 | 顏色依 CPU% 正確轉換 |
| EEPROM 寫入 | F8 | 正確轉換與讀出 |

---

**版本：** v1.0  
**撰寫者：** Arduino UNO / ATmega328P 韌體開發規格  
**崗位號碼：** 01  
**對應題目：** 113 年全國高級中等學校工業類科技藝競賽 — 電腦修護職類第二站
