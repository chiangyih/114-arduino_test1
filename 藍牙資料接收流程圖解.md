# è—ç‰™è³‡æ–™æ¥æ”¶æµç¨‹åœ–è§£

## ğŸ“¡ å®Œæ•´è³‡æ–™æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PC ç«¯      â”‚
â”‚ ç›£æ§ç¨‹å¼     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç™¼é€å‘½ä»¤ï¼ˆæ–‡å­—æ ¼å¼ï¼‰
       â”‚ ä¾‹ï¼šLOAD 50\n
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è—ç‰™ä»‹é¢    â”‚
â”‚  (é›»è…¦ç«¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç„¡ç·šå‚³è¼¸
       â”‚ 2.4 GHz
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HC-05     â”‚
â”‚  è—ç‰™æ¨¡çµ„    â”‚
â”‚  (Arduino)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ UART åºåˆ—åŸ 
       â”‚ TX â†’ RX (Pin 0)
       â”‚ 9600 bps
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Arduino    â”‚
â”‚  Serial.readâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ é€å­—å…ƒè®€å–
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚handleBluetoothâ”‚
â”‚   Data()    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å‘½ä»¤è§£æ
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸ·è¡ŒåŠŸèƒ½    â”‚
â”‚ WS2812/     â”‚
â”‚ EEPROM/TFT  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å›å‚³çµæœ
       â”‚ ACK æˆ– ERR
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Serial.    â”‚
â”‚  println()  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ é€é HC-05 å›å‚³
       â†“
     PC ç«¯
```

---

## ğŸ”„ é€å­—å…ƒè™•ç†æµç¨‹

```
é–‹å§‹
  â†“
Serial.available() > 0?
  â”œâ”€ å¦ â†’ è¿”å›ï¼ˆç¹¼çºŒç­‰å¾…ï¼‰
  â””â”€ æ˜¯
      â†“
  è®€å–ä¸€å€‹å­—å…ƒ c = Serial.read()
      â†“
  c æ˜¯æ›è¡Œç¬¦è™Ÿ (\n æˆ– \r)?
  â”œâ”€ å¦ â†’ receivedData += cï¼ˆç´¯ç©å­—å…ƒï¼‰â†’ ç¹¼çºŒè®€å–
  â””â”€ æ˜¯
      â†“
  receivedData æœ‰å…§å®¹?
  â”œâ”€ å¦ â†’ æ¸…ç©º receivedData â†’ ç¹¼çºŒè®€å–
  â””â”€ æ˜¯
      â†“
  trim()å»é™¤ç©ºç™½
      â†“
  åˆ¤æ–·å‘½ä»¤é¡å‹
  â”œâ”€ CONNECT â†’ è¨­å®šé€£ç·šç‹€æ…‹ â†’ å›å‚³ ACK
  â”œâ”€ DISCONNECT â†’ æ¸…é™¤é€£ç·š â†’ å›å‚³ ACK
  â”œâ”€ PING â†’ å¿ƒè·³ç¢ºèª â†’ å›å‚³ ACK
  â”œâ”€ LOAD xx â†’ è¨­å®š WS2812 â†’ å›å‚³ ACK
  â””â”€ WRITE xx â†’ å¯«å…¥ EEPROM â†’ å›å‚³ ACK/ERR
      â†“
  æ¸…ç©º receivedData = ""
      â†“
  ç¹¼çºŒè®€å–ä¸‹ä¸€å€‹å­—å…ƒ
```

---

## ğŸ“Š å‘½ä»¤è§£æç¯„ä¾‹ï¼šLOAD 50

### æ¥æ”¶éç¨‹

```
æ™‚é–“è»¸ â†’

t=0ms:   æ”¶åˆ° 'L'     receivedData = "L"
t=1ms:   æ”¶åˆ° 'O'     receivedData = "LO"
t=2ms:   æ”¶åˆ° 'A'     receivedData = "LOA"
t=3ms:   æ”¶åˆ° 'D'     receivedData = "LOAD"
t=4ms:   æ”¶åˆ° ' '     receivedData = "LOAD "
t=5ms:   æ”¶åˆ° '5'     receivedData = "LOAD 5"
t=6ms:   æ”¶åˆ° '0'     receivedData = "LOAD 50"
t=7ms:   æ”¶åˆ° '\n'    â†’ è§¸ç™¼è™•ç†
                           â†“
                      trim() è™•ç†
                           â†“
                  receivedData = "LOAD 50"
                           â†“
                  startsWith("LOAD ")?
                           â†“
                         æ˜¯ âœ“
                           â†“
              substring(5) = "50"
                           â†“
                   toInt() = 50
                           â†“
              åˆ¤æ–·é¡è‰²ï¼š50 <= 50
                           â†“
                    è¨­å®šç¶ è‰² ğŸŸ¢
                           â†“
                 Serial.println("ACK")
                           â†“
              receivedData = ""ï¼ˆæ¸…ç©ºï¼‰
```

### è¨˜æ†¶é«”ç‹€æ…‹è®ŠåŒ–

```
åˆå§‹ç‹€æ…‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ receivedData: ""    â”‚
â”‚ bleConnected: false â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”¶åˆ° "LOAD 50\n" å¾Œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ receivedData: ""    â”‚ â† å·²æ¸…ç©º
â”‚ bleConnected: true  â”‚ â† è‡ªå‹•è¨­å®š
â”‚ WS2812: ç¶ è‰² ğŸŸ¢     â”‚ â† å·²æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å‘½ä»¤è­˜åˆ¥é‚è¼¯

```
receivedData.trim() è™•ç†å¾Œ
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œå…¨æ¯”å°å‘½ä»¤      â”‚
â”‚ (ç„¡åƒæ•¸)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ == "PING"        â”‚ âœ“ å¿ƒè·³
â”‚ == "CONNECT"     â”‚ âœ“ é€£ç·š
â”‚ == "DISCONNECT"  â”‚ âœ“ ä¸­æ–·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¸ç¬¦åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç¶´æ¯”å°å‘½ä»¤      â”‚
â”‚ (æœ‰åƒæ•¸)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ startsWith       â”‚
â”‚   ("LOAD ")      â”‚ âœ“ CPU Loading
â”‚ startsWith       â”‚
â”‚   ("WRITE ")     â”‚ âœ“ EEPROM å¯«å…¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¸ç¬¦åˆ
      å¿½ç•¥å‘½ä»¤
```

---

## ğŸ”¢ åƒæ•¸æå–æµç¨‹

### LOAD å‘½ä»¤

```
åŸå§‹å­—ä¸²: "LOAD 65"
           â†“
  ä½ç½®ç´¢å¼•: 0123456
           â†“
substring(5): "65"
           â†“
   toInt(): 65
           â†“
  åˆ¤æ–·é¡è‰²: 65 åœ¨ 51-84 ç¯„åœ
           â†“
  è¨­å®šé¡è‰²: é»ƒè‰² ğŸŸ¡
```

### WRITE å‘½ä»¤

```
åŸå§‹å­—ä¸²: "WRITE 123"
           â†“
  ä½ç½®ç´¢å¼•: 0123456789
           â†“
substring(6): "123"
           â†“
   toInt(): 123
           â†“
 ç¯„åœæª¢æŸ¥: 0 <= 123 <= 255 âœ“
           â†“
  å¯«å…¥EEPROM: æˆåŠŸ
           â†“
  å›å‚³: ACK
```

---

## ğŸŒˆ WS2812 é¡è‰²æ±ºç­–æ¨¹

```
æ”¶åˆ° LOAD <VAL>
      â†“
  å–å¾—æ•¸å€¼ VAL
      â†“
  VAL <= 50?
  â”œâ”€ æ˜¯ â†’ è¨­å®šç¶ è‰² ğŸŸ¢ (0, 255, 0)
  â””â”€ å¦
      â†“
  VAL <= 84?
  â”œâ”€ æ˜¯ â†’ è¨­å®šé»ƒè‰² ğŸŸ¡ (255, 255, 0)
  â””â”€ å¦
      â†“
  è¨­å®šç´…è‰² ğŸ”´ (255, 0, 0)
      â†“
  æ›´æ–° 8 é¡† LED
      â†“
  strip.show()
      â†“
  Serial.println("ACK")
```

### å¯¦éš›ç¯„ä¾‹

```
LOAD 30  â†’ 30 <= 50  â†’ ç¶ è‰² ğŸŸ¢
LOAD 50  â†’ 50 <= 50  â†’ ç¶ è‰² ğŸŸ¢
LOAD 51  â†’ 51 > 50, 51 <= 84 â†’ é»ƒè‰² ğŸŸ¡
LOAD 84  â†’ 84 > 50, 84 <= 84 â†’ é»ƒè‰² ğŸŸ¡
LOAD 85  â†’ 85 > 84 â†’ ç´…è‰² ğŸ”´
LOAD 100 â†’ 100 > 84 â†’ ç´…è‰² ğŸ”´
```

---

## ğŸ’¾ EEPROM å¯«å…¥æµç¨‹

```
æ”¶åˆ° WRITE <DEC>
      â†“
  å–å¾—æ•¸å€¼ DEC
      â†“
  ç¯„åœæª¢æŸ¥
  0 <= DEC <= 255?
  â”œâ”€ æ˜¯
  â”‚   â†“
  â”‚ writeEEPROM(DEC)
  â”‚   â†“
  â”‚ EEPROM.write(0, DEC)
  â”‚   â†“
  â”‚ eepromValue = DEC
  â”‚   â†“
  â”‚ Serial.println("ACK")
  â”‚   â†“
  â”‚ æ›´æ–° TFT é¡¯ç¤ºï¼ˆå¦‚åœ¨ EEPROM é¸å–®ï¼‰
  â”‚
  â””â”€ å¦
      â†“
  Serial.println("ERR")
```

---

## ğŸ” è‡ªå‹•é€£ç·šåµæ¸¬æ©Ÿåˆ¶

```
Serial.available() > 0
      â†“
æ›´æ–°æ™‚é–“æˆ³è¨˜
lastBleDataTime = millis()
      â†“
bleConnected == false?
  â”œâ”€ æ˜¯
  â”‚   â†“
  â”‚ bleConnected = true
  â”‚   â†“
  â”‚ åœ¨ BLE é¸å–®?
  â”‚   â”œâ”€ æ˜¯ â†’ æ›´æ–° TFT é¡¯ç¤º "Connected" ğŸŸ¢
  â”‚   â””â”€ å¦ â†’ ä¸æ›´æ–° TFT
  â”‚
  â””â”€ å¦
      â†“
  ç¹¼çºŒè™•ç†è³‡æ–™
```

### ç¯„ä¾‹

```
ç‹€æ…‹ï¼šbleConnected = false
      â†“
æ”¶åˆ°ä»»ä½•è³‡æ–™ï¼ˆä¾‹å¦‚ "LOAD 50\n"ï¼‰
      â†“
è‡ªå‹•è¨­å®šï¼šbleConnected = true
      â†“
TFT é¡¯ç¤ºï¼šConnectedï¼ˆå¦‚åœ¨ BLE é¸å–®ï¼‰
      â†“
åŸ·è¡Œå‘½ä»¤ï¼šè¨­å®š WS2812 ç¶ è‰²
```

---

## â±ï¸ é€¾æ™‚ä¸­æ–·æ©Ÿåˆ¶

```
Loop è¿´åœˆæ¯ 10ms åŸ·è¡Œä¸€æ¬¡
      â†“
åœ¨ MENU_CONNECT_BLE é¸å–®?
  â”œâ”€ å¦ â†’ è·³éæª¢æŸ¥
  â””â”€ æ˜¯
      â†“
bleConnected == true?
  â”œâ”€ å¦ â†’ è·³éæª¢æŸ¥
  â””â”€ æ˜¯
      â†“
è¨ˆç®—ç¶“éæ™‚é–“
elapsed = millis() - lastBleDataTime
      â†“
elapsed > 5000 (5ç§’)?
  â”œâ”€ å¦ â†’ ç¹¼çºŒç­‰å¾…
  â””â”€ æ˜¯
      â†“
  bleConnected = false
      â†“
  æ›´æ–° TFT: "Disconnect" ğŸ”´
      â†“
  æ¸…é™¤ WS2812
```

### æ™‚é–“è»¸ç¯„ä¾‹

```
t=0s:     æ”¶åˆ° PING â†’ lastBleDataTime = 0
t=1s:     æª¢æŸ¥ï¼š1000ms < 5000ms âœ“ æ­£å¸¸
t=2s:     æª¢æŸ¥ï¼š2000ms < 5000ms âœ“ æ­£å¸¸
t=3s:     æª¢æŸ¥ï¼š3000ms < 5000ms âœ“ æ­£å¸¸
t=4s:     æª¢æŸ¥ï¼š4000ms < 5000ms âœ“ æ­£å¸¸
t=5s:     æª¢æŸ¥ï¼š5000ms >= 5000ms âœ— é€¾æ™‚ï¼
          â†“
      è¨­å®šä¸­æ–·é€£ç·š
          â†“
      TFT é¡¯ç¤º "Disconnect"
```

---

## ğŸ“¨ å›æ‡‰æ ¼å¼

### æˆåŠŸå›æ‡‰

```
Arduino:  Serial.println("ACK");
            â†“
å¯¦éš›ç™¼é€: A  C  K  \n
         41 43 4B 0A (16é€²ä½)
            â†“
PC ç«¯æ¥æ”¶: ser.readline() = "ACK\n"
            â†“
è™•ç†çµæœ: "ACK" (å»é™¤ \n)
```

### éŒ¯èª¤å›æ‡‰

```
Arduino:  Serial.println("ERR");
            â†“
å¯¦éš›ç™¼é€: E  R  R  \n
         45 52 52 0A (16é€²ä½)
            â†“
PC ç«¯æ¥æ”¶: ser.readline() = "ERR\n"
            â†“
è™•ç†çµæœ: "ERR" (å»é™¤ \n)
```

---

## ğŸ­ å¤šå‘½ä»¤é€£çºŒç™¼é€

```
PC ç«¯é€£çºŒç™¼é€ï¼š
t=0ms:   CONNECT\n
t=50ms:  LOAD 30\n
t=100ms: LOAD 65\n
t=150ms: LOAD 90\n

Arduino è™•ç†ï¼š
t=0ms:   æ”¶åˆ° CONNECT\n
         â†’ è™•ç† â†’ å›å‚³ ACK
t=50ms:  æ”¶åˆ° LOAD 30\n
         â†’ è™•ç† â†’ è¨­å®šç¶ è‰² â†’ å›å‚³ ACK
t=100ms: æ”¶åˆ° LOAD 65\n
         â†’ è™•ç† â†’ è¨­å®šé»ƒè‰² â†’ å›å‚³ ACK
t=150ms: æ”¶åˆ° LOAD 90\n
         â†’ è™•ç† â†’ è¨­å®šç´…è‰² â†’ å›å‚³ ACK
```

### ç·©è¡å€ç‹€æ…‹

```
è™•ç† CONNECTï¼š
receivedData = "CONNECT" â†’ è™•ç† â†’ ""

è™•ç† LOAD 30ï¼š
receivedData = "LOAD 30" â†’ è™•ç† â†’ ""

è™•ç† LOAD 65ï¼š
receivedData = "LOAD 65" â†’ è™•ç† â†’ ""
```

---

## ğŸš¦ ç‹€æ…‹æ©Ÿåœ–

```
        [ç­‰å¾…è³‡æ–™]
            â†“ Serial.available() > 0
        [è®€å–å­—å…ƒ]
            â†“
        /        \
     æ›è¡Œç¬¦      ä¸€èˆ¬å­—å…ƒ
       â†“           â†“
   [è™•ç†å‘½ä»¤]  [ç´¯ç©å­—å…ƒ]
       â†“           â†“
   [å›å‚³çµæœ]  [ç¹¼çºŒç­‰å¾…]
       â†“           â†“
   [æ¸…ç©ºç·©è¡] â”€â”€â”€â”€â”˜
       â†“
   [ç­‰å¾…è³‡æ–™]ï¼ˆå›åˆ°é–‹å§‹ï¼‰
```

---

## ğŸ” é™¤éŒ¯è³‡è¨Šæµ

### æ–°å¢é™¤éŒ¯è¼¸å‡ºç¯„ä¾‹

```cpp
void handleBluetoothData() {
    while (Serial.available() > 0) {
        char c = Serial.read();
        
        // é™¤éŒ¯ï¼šé¡¯ç¤ºæ”¶åˆ°çš„å­—å…ƒ
        Serial.print("RX: ");
        Serial.print(c);
        Serial.print(" (0x");
        Serial.print(c, HEX);
        Serial.println(")");
        
        if (c == '\n' || c == '\r') {
            if (receivedData.length() > 0) {
                // é™¤éŒ¯ï¼šé¡¯ç¤ºå®Œæ•´å‘½ä»¤
                Serial.print("CMD: [");
                Serial.print(receivedData);
                Serial.println("]");
                
                // ... è™•ç†å‘½ä»¤
            }
        }
    }
}
```

### é™¤éŒ¯è¼¸å‡ºç¯„ä¾‹

```
æ”¶åˆ° "LOAD 50\n" æ™‚çš„è¼¸å‡ºï¼š

RX: L (0x4C)
RX: O (0x4F)
RX: A (0x41)
RX: D (0x44)
RX:   (0x20)
RX: 5 (0x35)
RX: 0 (0x30)
RX: 
 (0x0A)
CMD: [LOAD 50]
Processing LOAD command with value: 50
Setting color: GREEN
ACK
```

---

## ğŸ“ˆ æ•ˆèƒ½åˆ†æ

### è™•ç†æ™‚é–“

```
å–®ä¸€å‘½ä»¤è™•ç†æ™‚é–“ï¼š
â”œâ”€ å­—å…ƒæ¥æ”¶ï¼šç´„ 8ms (8 bytes @ 9600 bps)
â”œâ”€ å­—ä¸²è™•ç†ï¼š< 1ms
â”œâ”€ å‘½ä»¤åŸ·è¡Œï¼š1-5ms
â””â”€ å›å‚³ ACKï¼šç´„ 4ms (4 bytes)
ç¸½è¨ˆï¼šç´„ 15-20ms
```

### è¨˜æ†¶é«”ä½¿ç”¨

```
è®Šæ•¸è¨˜æ†¶é«”ï¼š
â”œâ”€ receivedData: å‹•æ…‹ï¼ˆæœ€å¤§ç´„ 50 bytesï¼‰
â”œâ”€ bleConnected: 1 byte
â”œâ”€ lastBleDataTime: 4 bytes (unsigned long)
â””â”€ å…¶ä»–è®Šæ•¸ï¼š< 10 bytes
ç¸½è¨ˆï¼šç´„ 65 bytesï¼ˆSRAM 2KB çš„ 3%ï¼‰
```

---

**æ–‡ä»¶ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2025-01-19  
**åœ–è§£é¡å‹**ï¼šæµç¨‹åœ–ã€ç‹€æ…‹æ©Ÿåœ–ã€æ™‚åºåœ–
